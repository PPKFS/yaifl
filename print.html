<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Yaifl Docs</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="intro/tech.html">The Tech</a></li><li class="chapter-item expanded affix "><a href="intro/structure.html">Structure of the book</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">The Yaifl Library</li><li class="chapter-item expanded "><a href="foundations/foundations.html"><strong aria-hidden="true">1.</strong> Foundations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="foundations/cabal.html"><strong aria-hidden="true">1.1.</strong> Cabal, Extensions, Dependencies</a></li><li class="chapter-item expanded "><a href="foundations/architecture.html"><strong aria-hidden="true">1.2.</strong> Project Architecture</a></li><li class="chapter-item expanded "><a href="foundations/worldmodel.html"><strong aria-hidden="true">1.3.</strong> wm :: WorldModel</a></li><li class="chapter-item expanded "><a href="foundations/entities.html"><strong aria-hidden="true">1.4.</strong> Entities, Stores and Objects</a></li><li class="chapter-item expanded "><a href="foundations/effects.html"><strong aria-hidden="true">1.5.</strong> Effects</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="foundations/logging.html"><strong aria-hidden="true">1.5.1.</strong> Logging</a></li></ol></li><li class="chapter-item expanded "><a href="world/state.html"><strong aria-hidden="true">1.6.</strong> The World State</a></li><li class="chapter-item expanded "><a href="foundations/construction.html"><strong aria-hidden="true">1.7.</strong> Construction and Execution</a></li></ol></li><li class="chapter-item expanded "><a href="world/worldmodel.html"><strong aria-hidden="true">2.</strong> The World Model</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="world/things.html"><strong aria-hidden="true">2.1.</strong> Things and Rooms</a></li><li class="chapter-item expanded "><a href="world/reification.html"><strong aria-hidden="true">2.2.</strong> Reification</a></li><li class="chapter-item expanded "><a href="world/properties.html"><strong aria-hidden="true">2.3.</strong> Properties</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="world/getsetmodify.html"><strong aria-hidden="true">2.3.1.</strong> Get, Set, Modify</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="rulebooks/rulebooks.html"><strong aria-hidden="true">3.</strong> Rulebooks, Actions, and Activities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rulebooks/running.html"><strong aria-hidden="true">3.1.</strong> Running a Rulebook</a></li><li class="chapter-item expanded "><a href="rulebooks/ap.html"><strong aria-hidden="true">3.2.</strong> Action Processing</a></li><li class="chapter-item expanded "><a href="rulebooks/activities.html"><strong aria-hidden="true">3.3.</strong> Activities</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">Reference</li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Properties</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Actions</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Activities</div></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Examples</li><li class="chapter-item expanded "><a href="tests/framework.html"><strong aria-hidden="true">7.</strong> Testing Framework</a></li><li class="chapter-item expanded "><a href="tests/chapter3.html"><strong aria-hidden="true">8.</strong> Chapter 3 - Kinds</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tests/bic.html"><strong aria-hidden="true">8.1.</strong> Bic</a></li><li class="chapter-item expanded "><a href="tests/verbosity.html"><strong aria-hidden="true">8.2.</strong> Verbosity</a></li></ol></li><li class="chapter-item expanded "><a href="tests/new.html"><strong aria-hidden="true">9.</strong> New Examples</a></li><li class="chapter-item expanded "><a href="tests/missing.html"><strong aria-hidden="true">10.</strong> Missing Examples</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="other_miscellania.html">Module Headers and Other Miscellania</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Yaifl Docs</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="yaifl---yet-another-interactive-fiction-library"><a class="header" href="#yaifl---yet-another-interactive-fiction-library">Yaifl - <strong>Y</strong>et <strong>A</strong>nother <strong>I</strong>nteractive <strong>F</strong>iction <strong>L</strong>ibrary</a></h1>
<p>Yaifl is a library for writing interactive fiction (&quot;text adventures&quot;) in Haskell. 
It is heavily based off <a href="http://inform7.com/">Inform7 by Graham Nelson</a> with regards to the world model and standard actions, 
and uses Inform7's examples as the basis unit tests.</p>
<h2 id="but-why-not-just-use-inform"><a class="header" href="#but-why-not-just-use-inform">But why not just use Inform?</a></h2>
<ul>
<li>I doubt anyone will ever choose this over Inform7 to actually produce a work of IF.</li>
<li>The internals of Inform are not the easiest to pick apart. It does a huge amount of work under the hood and even with the
incredibly verbose debug logging, it's almost black magic. <em>And then</em> assuming you can find your way around the compiler itself,
the world model/parser/meat of the library is greatly intertwined with Inform 6.</li>
<li>I want to avoid a handful of Inform's restrictions at a fundamental level (e.g. objects are considered entirely unique). To this
extent, it's less of a library for <em>writing</em> pieces of interactive fiction and more for fiddling about with <em>text adventure world models</em>.</li>
<li>I'm a programmer, so whilst I have a great deal of respect for the whole English language programming thing, I'd rather see
what cool Haskell stuff I can do with it. A lot of weird things are done due to the limitations of the language itself and its targets
(i.e. the Z-Machine, or Glulx). For example, did you know that the action <strong>to look</strong> makes a table of <strong>every item in the entire game</strong>?</li>
</ul>
<h2 id="why-this-book"><a class="header" href="#why-this-book">Why this book?</a></h2>
<p>I found I was trying to be a good samaritan and document my code, but given that the library works more in vague ideas
than function signatures, Haddock comments weren't ideal. Plus the structure of how the code needs to be to compile with
all its module dependencies is different to how I want to read my own documentation, and <em>also</em> different to how I want to
present my work if anyone finds it interesting. </p>
<p>As an aside, I also I wanted to try this whole &quot;literate programming&quot; thing. The main reason I hadn't looked into it more before
was the large brick wall of getting a build system up as well as dealing with separating literate source from compilable/editable source.
I doubt anyone will read this book except me, but I saw <a href="https://entangled.github.io">Entangled</a> presented at a talk and it seemed a cool idea I wanted to try.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-tech"><a class="header" href="#the-tech">The Tech</a></h1>
<h2 id="the-model"><a class="header" href="#the-model">The Model</a></h2>
<h2 id="haskell"><a class="header" href="#haskell">Haskell</a></h2>
<h2 id="literate-programming"><a class="header" href="#literate-programming">Literate Programming</a></h2>
<h2 id="the-book"><a class="header" href="#the-book">The Book</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-read-this-book"><a class="header" href="#how-to-read-this-book">How to read this book</a></h1>
<ul>
<li>don't lmao, it sucks</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="foundations"><a class="header" href="#foundations">Foundations</a></h1>
<p>This section covers the groundwork for getting everything to fit together.</p>
<ul>
<li><a href="foundations/foundations/cabal.html">Cabal, Extensions, Dependencies</a> documents the Cabal files and other various configs.</li>
<li><a href="foundations/foundations/architecture.html">Project Architecture</a> describes a higher-level structure of the library as a whole,
and how we apply the Three-Layer Cake principle to try and keep the design clean.</li>
<li><a href="foundations/foundations/worldmodel.html">wm :: WorldModel</a> covers the <code>wm</code> type parameter that appears everywhere in the code.</li>
<li><a href="foundations/world/entities.html">Entities, Stores and Objects</a> covers the most basic building blocks of the library. This is put early on
because they permeate everything.</li>
<li><a href="foundations/foundations/effects.html">Effects</a> documents the effect stack.</li>
<li><a href="foundations/world/state.html">The World State</a> is the glue that holds everything together, as the entire program is basically an overly
convoluted wrapper around <code>State (World wm) a</code>.</li>
<li><a href="foundations/foundations/construction.html">Construction and Execution</a> is about building a world and then running the game itself.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cabal-extensions-dependencies"><a class="header" href="#cabal-extensions-dependencies">Cabal, Extensions, Dependencies</a></h1>
<p>This is probably a pretty dull page, so if you only care about the interesting stuff
you can skip it. But I wanted to do this literate programming thing properly, and also
it ensures I know what's going on in my <code>.cabal</code> files.</p>
<h2 id="metadata"><a class="header" href="#metadata">Metadata</a></h2>
<p>Everything here is fairly standard project information.</p>
<pre><code class="language-cabal file=yaifl.cabal header=&quot;1&quot;">cabal-version:   3.0
name:            yaifl
version:         0.0.0.1
synopsis:        Yet another interactive fiction library.
description:     Yet another interactive fiction library.
homepage:        https://github.com/PPKFS/yaifl
bug-reports:     https://github.com/PPKFS/yaifl/issues
license:         MIT
author:          Avery
maintainer:      Avery &lt;thecommunistduck@hotmail.co.uk&gt;
copyright:       2022 Avery
category:        Game Development
build-type:      Simple
tested-with: GHC == 9.2.1

source-repository head
  type:     git
  location: https://github.com/PPKFS/yaifl.git
</code></pre>
<div class="admonition question">
<div class="admonition-title">
<p>Why does the project use GHC 9.2.1?</p>
</div>
<div>
<ul>
<li>Using <code>GHC2021</code> as a <code>default-language</code> only works in 9.2, and it saves writing a huge number of extensions.</li>
<li><code>9.2.2</code> doesn't (yet) support HLS. Even with <code>entangled</code>, I like HLS because I like keeping my sanity.</li>
<li>It could probably work just fine with GHC as low as 8.8.x, but this is untested.</li>
</ul>
</div>
</div>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>This is a pretty standard dependency list.</p>
<pre><code class="language-cabal file=yaifl.cabal">common common-options
  build-depends:
      base
    , containers
    , template-haskell
    , text
    , solitude
    , optics
    , mtl 
    -- to remove
    , hspec 
    -- to remove
</code></pre>
<p>I still have no idea why the first 3 of these aren't in <code>base</code>. <code>solitude</code> is my personal prelude, which is
mostly re-exports of the excellent <a href="https://hackage.haskell.org/package/relude">relude</a> alternative prelude and
also some <code>optics</code>-lens things. </p>
<div class="admonition question">
<div class="admonition-title">
<p>Why optics over lens?</p>
</div>
<div>
<ul>
<li>No idea, I just wanted to.</li>
<li>The error messages and the explicit <code>AffineTraversal</code> you get from combining a <code>Lens</code> and a <code>Prism</code> are cool though.</li>
</ul>
</div>
</div>
<pre><code class="language-cabal file=yaifl.cabal">    , display
    , chapelure
    , formatting
    , pretty-simple
    , prettyprinter
    , prettyprinter-ansi-terminal
</code></pre>
<p><code>display</code> and <code>chapelure</code> are for being <em>technically</em> lawful with <code>Show</code> instances when it comes to logging and
for making pretty error messages. The other libraries are various pretty printing for pretty logging and output.</p>
<pre><code class="language-cabal file=yaifl.cabal">    , aeson
    , katip
    , enummapset
    , haskell-src-meta
    , haskell-src-exts
    , neat-interpolation
    , sandwich
</code></pre>
<ul>
<li><code>enummapset</code> is a nice set of wrappers for using <code>Enum</code> keys in <code>IntMap</code>s for better performance (i.e. <code>Entity</code>).</li>
<li><code>haskell-src-*</code> I use because writing well-formed TH is hard, and I wanted to just write Haskell strings with
text substitutions in. </li>
<li><code>neat-interpolation</code> makes wrapped raw string quasi-quotes better, which is important given
how many room descriptions are very long lines of text. </li>
<li><code>sandwich</code> is a really sweet looking testing library so I
wanted to try it.</li>
<li><code>katip</code> for logging and <code>aeson</code> for writing some wrappers to customise the logging format.</li>
</ul>
<h2 id="ghc-extensions"><a class="header" href="#ghc-extensions">GHC extensions</a></h2>
<pre><code class="language-cabal file=yaifl.cabal">  ghc-options:
    -Wall -Wcompat -Widentities -Wredundant-constraints 
    -fhide-source-paths -Wno-unused-top-binds
    -Wmissing-deriving-strategies -O2 -flate-specialise
    -fspecialise-aggressively -fprint-potential-instances
    -fno-warn-unused-do-bind -haddock -fwrite-ide-info
  default-language:   GHC2021
  default-extensions:
    NoImplicitPrelude
    BlockArguments
    DataKinds
    DerivingStrategies
    FunctionalDependencies
    LambdaCase
    MultiWayIf
    OverloadedStrings
    TypeFamilies
</code></pre>
<p>We enable a whole bunch of options and extensions. Notably <code>NoImplicitPrelude</code> makes it easier than fiddling with
mixins for using <code>solitude</code> over <code>Prelude</code>, <code>BlockArguments</code> for my love of using inline <code>do</code> blocks, and <code>TypeFamilies</code>
because I like to try and be smarter than I am.</p>
<h2 id="library-stanza"><a class="header" href="#library-stanza">Library stanza</a></h2>
<pre><code class="language-cabal file=yaifl.cabal">library
  import:          common-options
  hs-source-dirs:  src
  exposed-modules:
    Yaifl

    Yaifl.Actions.Action
    Yaifl.Actions.Going
    Yaifl.Actions.Looking

    Yaifl.Activities.Activity
    Yaifl.Activities.ChoosingNotableLocaleObjects
    Yaifl.Activities.DescribingLocale
    Yaifl.Activities.PrintingADarkRoom
    Yaifl.Activities.PrintingDescriptionOfADarkRoom
    Yaifl.Activities.PrintingLocaleParagraphAbout
    Yaifl.Activities.PrintingNameOfSomething

    Yaifl.ActivityCollection
    Yaifl.Common
    Yaifl.Directions
    Yaifl.Game
    Yaifl.Logger

    Yaifl.Objects.Create
    Yaifl.Objects.Dynamic
    Yaifl.Objects.Missing
    Yaifl.Objects.Move
    Yaifl.Objects.Object
    Yaifl.Objects.ObjectData
    Yaifl.Objects.Query
    Yaifl.Objects.Room

    Yaifl.ObjectSpecifics
    Yaifl.Properties.Container
    Yaifl.Properties.Enclosing
    Yaifl.Properties.Openable
    Yaifl.Properties.Property
    Yaifl.Properties.Query
    Yaifl.Properties.Supporter
    Yaifl.Properties.TH

    Yaifl.Rulebooks.ActionProcessing
    Yaifl.Rulebooks.Args
    Yaifl.Rulebooks.Rulebook
    Yaifl.Rulebooks.WhenPlayBegins

    Yaifl.Say
    Yaifl.World
    Yaifl.WorldInfo
</code></pre>
<h2 id="test-stanza"><a class="header" href="#test-stanza">Test stanza</a></h2>
<pre><code class="language-cabal file=yaifl.cabal">test-suite yaifl-test
  import:             common-options
  type:               exitcode-stdio-1.0
  hs-source-dirs:     test
  main-is:            Spec.hs
  build-depends:
    , hspec
    , yaifl

  ghc-options:        -threaded -rtsopts -with-rtsopts=-N
  default-extensions:
    QuasiQuotes
    TemplateHaskell

  other-modules:
    Yaifl.Test.Chapter3.Bic
    Yaifl.Test.Chapter3.Common
    Yaifl.Test.Chapter3.Verbosity
    Yaifl.Test.Common
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="project-architecture"><a class="header" href="#project-architecture">Project Architecture</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="wm--worldmodel"><a class="header" href="#wm--worldmodel"><code>wm :: WorldModel</code></a></h1>
<h2 id="the-problem"><a class="header" href="#the-problem">The problem</a></h2>
<p>One thing that has repeatedly annoyed me when trying to hack around on <code>yaifl</code> is the desire to be as general as possible,
but whilst doing my best to avoid writing imperative code but in Haskell. One of these major headscratching problems was how
to have something akin to extensible records but in a more Haskell-y way. For instance, take object types. We can provide a 
standard library of <code>Thing</code>, <code>Room</code>, <code>Door</code>, <code>Person</code>, <code>Vehicle</code>, etc. just fine; but what if we want to have a <code>Gate</code>? In
an imperative language this is fine - just inherit from <code>Door</code>. In Haskell we could approximate this in the same way <code>Parsec</code>
deals with its error types:</p>
<pre><code class="language-haskell">
data ObjectType a = ThingType Thing | DoorType Door | RoomType Room ... | Other a
</code></pre>
<p>And we are then open (as long as the user supplied <code>a</code> satisfies some conditions) to extensionality but closed at compile time.
But this has the drawback that if you want this open-closed hierarchy on <em>many</em> types of data, you have a monolithic state that
looks something like <code>MonolithicState a b c d e f g</code>. </p>
<ul>
<li>We want horizontally extendable object types, so we can start with <code>MonolithicWorld objType</code>. All cool.</li>
<li>Now we want directions; whilst the compass points are probably fine for nearly every game, sometimes you might want to have turnwise or widdershins. Now you have <code>MonolithicWorld objType directionType</code>. </li>
<li>What about arbitrary data variables you want to keep track of during the game? Now you've got <code>MonolithicWorld objType directionType variableRecord</code>. </li>
<li>And so on.</li>
</ul>
<p>Chances are that most of those are going to be <code>()</code> - you don't want extra directions, or you don't define a special kind of door - but it's a huge pain to write out each time.</p>
<p>I tried to extract out the parametric types into their own cluster, and then work in an <code>mtl</code>-style way of component instances and typeclasses:</p>
<pre><code class="language-haskell">data MonolithicWorld s = MonolithicWorld
  { ...
  , worldData :: s
  }

data WorldData a b c d e f g = WorldData
  { things :: Store (Object a)
  , directions :: Store (Direction b)
  ...
  -- and so on
  }

class HasThings s a where
  things :: Lens' (MonolithicWorld s) (Store (Object a))

class HasDirections s b where
  directions :: Lens' (MonolithicWorld s) (Store (Direction b))
</code></pre>
<p>But this quickly ran into problems that each of these different parameterised data types needed an <code>a</code> or a <code>b</code> and these constraints bubbled up to the top...and even then, I'd often get <code>ambiguous type variable a1</code> issues.</p>
<p>What if there was a way to do this with some type-level nonsense?</p>
<h2 id="the-worldmodel-type-families"><a class="header" href="#the-worldmodel-type-families">The WorldModel type families</a></h2>
<p>Behold, a whole bunch of random <code>Type</code>s!</p>
<pre><code class="language-haskell id=world-model">data WorldModel = WorldModel Type Type Type Type
</code></pre>
<p>By using <code>DataKinds</code>, we can promote this to the type level. We can now start making types that look like</p>
<pre><code class="language-haskell">data SomeExtraObjTypes = GateType Gate
type Score = Int
type AWorldModel = 'WorldModel SomeExtraObjTypes () () Score
</code></pre>
<p>which is great; we can parameterise everything by <code>(wm :: WorldModel)</code>, and now we have only one type variable instead of 4 (or more)! But record field accessors don't work at the type-level (F in chat), so we need to write a little boilerplate:</p>
<pre><code class="language-haskell id=world-model-families">type family WMObjSpecifics (wm :: WorldModel) :: Type where
  WMObjSpecifics ('WorldModel objSpec dir o v) = objSpec

type family WMDirections (wm :: WorldModel) :: Type where
  WMDirections ('WorldModel objSpec dir o v) = dir 

type family WMValues (wm :: WorldModel) :: Type where
  WMValues ('WorldModel objSpec dir o v) = o
</code></pre>
<p>How does this work? Without doing a terrible job of massacring an explanation of how type families work, we can view these as very basic dependent types; given some type instantiation of <code>wm :: WorldModel</code>, we have an associated type <code>WMObjSpecifics</code> that is defined by the first member of that type. Now, rather than ever referring to the <code>objSpec</code> we can refer to <code>WMObjSpecifics wm</code>. Everything is unified and there's no unnecessary typeclass baggage, rejoice!</p>
<p>Well, there is one slight issue - this breaks GHC's <code>deriving</code> machinery. Types that contain a <code>WMFoo wm</code> have to instead use quantified instance derivations; for instance we may need to define an <code>Ord</code> instance like</p>
<pre><code class="language-haskell">deriving stock instance (Ord (WMDirections wm), Ord (WMObjSpecifics wm)) =&gt; Ord (FooBar wm)
</code></pre>
<p>which gets minorly annoying. But thanks to <code>ConstraintKinds</code> we can write some tidy helper types.</p>
<pre><code class="language-haskell id=world-model-constraints">type WMConstr (c :: Type -&gt; Constraint) wm = (c (WMObjSpecifics wm), c (WMValues wm), c (WMDirections wm))
type WMShow wm = WMConstr Show wm
type WMRead wm = WMConstr Read wm
type WMOrd wm = WMConstr Ord wm
type WMEq wm = WMConstr Eq wm
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="entities-stores-and-objects"><a class="header" href="#entities-stores-and-objects">Entities, Stores and Objects</a></h1>
<p>Finally, we can start actually seeing some Haskell. This chapter contains the 3 most basic building blocks:</p>
<ul>
<li><strong>Entities</strong> - An ID that allows us to circumvent immutability by breaking apart references between objects.</li>
<li><strong>Stores</strong> - <code>Map</code>s of <code>Entity</code>s to various objects.</li>
<li><strong>Objects</strong> - Game objects, spanning from the physical (keys, doors, people) to the intangible (rooms, etc).</li>
</ul>
<p>Between these 3, we can construct (with some difficulty) a world model that can represent some domain of IF,
but not one that can be interacted with.</p>
<h2 id="entities"><a class="header" href="#entities">Entities</a></h2>
<p>And the big reveal of the lynchpin of the entire library is...</p>
<pre><code class="language-haskell id=entity-def">newtype Entity = Entity
  { unID :: Int
  } deriving stock   (Show, Generic)
    deriving newtype (Eq, Num, Read, Bounded, Hashable, Enum, Ord, Real, Integral)
</code></pre>
<p>A <code>newtype</code> wrapper around  <code>Int</code>. Yup, that's about it. One nice feature is that we can, under the assumption
that nobody does something strange (like turning a <code>Thing</code> into a <code>Room</code>), determine whether a given <code>Entity</code> 
refers to a <code>Thing</code> or a <code>Room</code> by whether we generated the ID by counting up or down:</p>
<pre><code class="language-haskell id=thing-or-room">isThing ::
  (HasID a)
  =&gt; a
  -&gt; Bool
isThing a = getID a &gt;= 0

isRoom ::
  (HasID a)
  =&gt; a
  -&gt; Bool
isRoom = not . isThing
</code></pre>
<p>It's also nice to have a way to always get an <code>Entity</code> from a construct:</p>
<pre><code class="language-haskell id=has-id">class HasID n where
  getID :: n -&gt; Entity

instance HasID Entity where
  getID = id
</code></pre>
<p>We also then reserve a few IDs for the 'default' objects which we never want to see at runtime, but need at construction
time to avoid unnecessary <code>Maybe</code>s.</p>
<pre><code class="language-haskell id=base-ids">defaultVoidID :: Entity
defaultVoidID = Entity (-1)

defaultNothingID :: Entity
defaultNothingID = Entity 0

defaultPlayerID :: Entity
defaultPlayerID = Entity 1
</code></pre>
<h2 id="stores"><a class="header" href="#stores">Stores</a></h2>
<p>A <code>Store</code> is a map from <code>Entity</code>s to <code>a</code>s. Usually this is some flavour of <code>Object wm d</code>, but we can also use
<code>Store Entity</code> for relations and things like that.</p>
<pre><code class="language-haskell id=store-def">-- import qualified Data.EnumMap.Strict as EM
newtype Store a = Store
  { unStore :: EM.EnumMap Entity a
  } deriving stock   (Show, Generic)
    deriving newtype (Eq, Ord, Read)

emptyStore :: Store a
emptyStore = Store EM.empty
</code></pre>
<h3 id="enummap-and-optics"><a class="header" href="#enummap-and-optics">EnumMap and Optics</a></h3>
<p><code>EnumMap</code> (and its sibling <code>EnumSet</code>) are nice convenient <code>newtype</code> wrappers around <code>IntMap</code>, but they're not
quite cut out for a) <em>further</em> <code>newtype</code> wrappers around <em>them</em>, and b) the instances for nice <code>Lens</code>/<code>Optics</code> things.</p>
<p>First let's define our own <a href="https://hackage.haskell.org/package/containers-0.6.5.1/docs/Data-Map-Strict.html#v:alterF"><code>alterF</code></a> for <code>EnumMap</code> and then <em>another</em> for a <code>newtype</code> wrapper...</p>
<pre><code class="language-haskell id=alter-store">alterEMF :: 
  (Functor f, Enum k)
  =&gt; (Maybe a -&gt; f (Maybe a))
  -&gt; k
  -&gt; EM.EnumMap k a 
  -&gt; f (EM.EnumMap k a)
alterEMF upd k m = EM.intMapToEnumMap &lt;$&gt; IM.alterF upd (fromEnum k) (EM.enumMapToIntMap m)

alterNewtypeEMF :: 
  (Functor f, Enum k)
  =&gt; (Maybe a -&gt; f (Maybe a))
  -&gt; k
  -&gt; (nt -&gt; EM.EnumMap k a)
  -&gt; (EM.EnumMap k a -&gt; nt)
  -&gt; nt
  -&gt; f nt
alterNewtypeEMF upd k unwrap wrap' m = wrap' &lt;$&gt; alterEMF upd k (unwrap m)
</code></pre>
<p>Which we can now use for a nice and tidy <code>At</code> instance.</p>
<pre><code class="language-haskell id=store-at">instance At (Store a) where
  at k = lensVL $ \f -&gt; alterNewtypeEMF f k unStore Store
</code></pre>
<p>Finally, we choose the obvious instantiations for the associated index types.</p>
<pre><code class="language-haskell id=store-instances">type instance IxValue (Store a) = a
type instance Index (Store a) = Entity
instance Ixed (Store a)
</code></pre>
<p>Which means we can now write use our lenses as <code>someStore ^? at someEntity</code> rather than <code>someStore ^? coercedTo @(EnumMap Entity a) % to unStore % at someEntity</code>, or some other verbose beast.</p>
<h2 id="objects"><a class="header" href="#objects">Objects</a></h2>
<pre><code>-- | Again lifted directly from Inform; this sets whether to always print room
-- descriptions (No..) even if the room is visited, to only print them on the first
-- entry (Sometimes..) or never.
data RoomDescriptions = SometimesAbbreviatedRoomDescriptions
  | AbbreviatedRoomDescriptions
  | NoAbbreviatedRoomDescriptions 
  deriving stock (Eq, Show, Read, Ord, Enum, Generic)

data WorldStage = Construction | Playing 
  deriving stock (Eq, Show, Read, Ord, Enum, Generic)

-- | For now, a timestamp is simply an integer. The timestamp is updated whenever some
-- modification is made to the 'World'; therefore it does not directly correspond to
-- some sort of in-game turn counter. For example, throwing an object would result in
-- multiple timestamp jumps (an object moving, potential interactions on it hitting
-- something) whereas a sequence of 10 look actions will not (as the world does not
-- change). This is primarily used to ensure we can cache updates of objects that
-- change properties (e.g. strings).
newtype Timestamp = Timestamp
  { unTimestamp :: Int
  } deriving stock   (Show, Read, Generic)
    deriving newtype (Eq, Num, Enum, Ord, Real, Integral)


-- | A WorldModel is the canonical implementation of the `wm` world model parameter.
-- the reason for its existence is primarily so we can avoid having massive type
-- sigs everywhere for `World`.




</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="effects"><a class="header" href="#effects">Effects</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="logging"><a class="header" href="#logging">Logging</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-world-state"><a class="header" href="#the-world-state">The World State</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="construction-and-execution"><a class="header" href="#construction-and-execution">Construction and Execution</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-world-model"><a class="header" href="#the-world-model">The World Model</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="things-and-rooms"><a class="header" href="#things-and-rooms">Things and Rooms</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reification"><a class="header" href="#reification">Reification</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="properties"><a class="header" href="#properties">Properties</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="get-set-modify"><a class="header" href="#get-set-modify">Get, Set, Modify</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rulebooks-actions-and-activities"><a class="header" href="#rulebooks-actions-and-activities">Rulebooks, Actions, and Activities</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="running-a-rulebook"><a class="header" href="#running-a-rulebook">Running a Rulebook</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="action-processing"><a class="header" href="#action-processing">Action Processing</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="activities"><a class="header" href="#activities">Activities</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="testing-framework"><a class="header" href="#testing-framework">Testing Framework</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-3---kinds"><a class="header" href="#chapter-3---kinds">Chapter 3 - Kinds</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bic"><a class="header" href="#bic">Bic</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="verbosity"><a class="header" href="#verbosity">Verbosity</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="new-examples"><a class="header" href="#new-examples">New Examples</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-examples"><a class="header" href="#missing-examples">Missing Examples</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="module-headers-and-other-miscellania"><a class="header" href="#module-headers-and-other-miscellania">Module Headers and Other Miscellania</a></h1>
<p>In the spirit of literate programming I needed to put the module import/export lists somewhere
but I didn't want to spam the other files. So they can all go in here.</p>
<h2 id="common"><a class="header" href="#common">Common</a></h2>
<pre><code class="language-haskell file=src/Yaifl/Common.hs">{-# OPTIONS_GHC -Wno-orphans #-}

module Yaifl.Common
  (-- * Datatypes
  Entity(..)
  , Store(..)
  , HasID(..)
  , Timestamp(..)
  , WorldModel(..)
  , RoomDescriptions(..)
  , WorldStage(..)
  
  , defaultVoidID
  , emptyStore
  -- * Object querying
  , isThing
  , isRoom
    -- * Type family nonsense
  , WMObjSpecifics
  , WMValues
  , WMDirections

  , WMShow
  , WMRead
  , WMOrd
  , WMEq
  )
where

import Solitude
import qualified Data.EnumMap.Strict as EM
import qualified Data.IntMap.Strict as IM
import Display

instance {-# OVERLAPPABLE #-} Display a where
  display = const &quot;No display instance&quot;

&lt;&lt;entity-def&gt;&gt;
&lt;&lt;thing-or-room&gt;&gt;
&lt;&lt;has-id&gt;&gt;
&lt;&lt;base-ids&gt;&gt;
&lt;&lt;store-def&gt;&gt;
&lt;&lt;alter-store&gt;&gt;
&lt;&lt;store-at&gt;&gt;
&lt;&lt;store-instances&gt;&gt;

&lt;&lt;world-model&gt;&gt;
&lt;&lt;world-model-families&gt;&gt;
&lt;&lt;world-model-constraints&gt;&gt;
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </body>
</html>
