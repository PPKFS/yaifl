<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>WorldModel and WMx Type Families - Yaifl Docs</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../assets/mdbook-admonish.css">
        <link rel="stylesheet" href="../././mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../foundations/tech.html">The Tech</a></li><li class="chapter-item expanded affix "><a href="../foundations/structure.html">Structure of the book</a></li><li class="chapter-item expanded affix "><a href="../foundations/cabal.html">Cabal, Extensions, Dependencies</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">The Yaifl Library</li><li class="chapter-item expanded "><a href="../foundations/effects.html"><strong aria-hidden="true">1.</strong> Effects</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../effects/say.html"><strong aria-hidden="true">1.1.</strong> Saying</a></li><li class="chapter-item expanded "><a href="../effects/logging.html"><strong aria-hidden="true">1.2.</strong> Logging</a></li></ol></li><li class="chapter-item expanded "><a href="../worldmodel.html"><strong aria-hidden="true">2.</strong> The World Model</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../worldmodel/typefamilies.html" class="active"><strong aria-hidden="true">2.1.</strong> WorldModel and WMx Type Families</a></li><li class="chapter-item expanded "><a href="../worldmodel/objects.html"><strong aria-hidden="true">2.2.</strong> Objects</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../worldmodel/objects/entities-stores.html"><strong aria-hidden="true">2.2.1.</strong> Entities and Stores</a></li><li class="chapter-item expanded "><a href="../worldmodel/objects/objects.html"><strong aria-hidden="true">2.2.2.</strong> Objects, At Last</a></li><li class="chapter-item expanded "><a href="../worldmodel/objects/query.html"><strong aria-hidden="true">2.2.3.</strong> Object Querying Effect</a></li><li class="chapter-item expanded "><a href="../worldmodel/objects/data.html"><strong aria-hidden="true">2.2.4.</strong> ThingData and RoomData</a></li><li class="chapter-item expanded "><a href="../worldmodel/objects/specifics.html"><strong aria-hidden="true">2.2.5.</strong> Object Specifics</a></li><li class="chapter-item expanded "><a href="../worldmodel/objects/dynamic.html"><strong aria-hidden="true">2.2.6.</strong> Dynamic Objects</a></li><li class="chapter-item expanded "><a href="../worldmodel/objects/creation.html"><strong aria-hidden="true">2.2.7.</strong> Creating Objects</a></li><li class="chapter-item expanded "><a href="../worldmodel/objects/move.html"><strong aria-hidden="true">2.2.8.</strong> Moving Objects</a></li></ol></li><li class="chapter-item expanded "><a href="../worldmodel/rooms.html"><strong aria-hidden="true">2.3.</strong> Rooms and Spatial Stuff</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../worldmodel/directions.html"><strong aria-hidden="true">2.3.1.</strong> Directions</a></li><li class="chapter-item expanded "><a href="../worldmodel/connections.html"><strong aria-hidden="true">2.3.2.</strong> Making Connections</a></li></ol></li><li class="chapter-item expanded "><a href="../properties.html"><strong aria-hidden="true">2.4.</strong> Properties</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../properties/getsetmodify.html"><strong aria-hidden="true">2.4.1.</strong> Get, Set, Modify with TemplateHaskell</a></li><li class="chapter-item expanded "><a href="../properties/standard.html"><strong aria-hidden="true">2.4.2.</strong> Standard Properties</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../properties/std/enclosing.html"><strong aria-hidden="true">2.4.2.1.</strong> Enclosing</a></li><li class="chapter-item expanded "><a href="../properties/std/openable.html"><strong aria-hidden="true">2.4.2.2.</strong> Openable</a></li><li class="chapter-item expanded "><a href="../properties/std/container.html"><strong aria-hidden="true">2.4.2.3.</strong> Container</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../rulebooks.html"><strong aria-hidden="true">3.</strong> Rulebooks, Actions, and Activities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rulebooks/running.html"><strong aria-hidden="true">3.1.</strong> Running a Rulebook</a></li><li class="chapter-item expanded "><a href="../rulebooks/ap.html"><strong aria-hidden="true">3.2.</strong> Action Processing</a></li><li class="chapter-item expanded "><a href="../rulebooks/activities.html"><strong aria-hidden="true">3.3.</strong> Activities</a></li></ol></li><li class="chapter-item expanded "><a href="../construction.html"><strong aria-hidden="true">4.</strong> Construction and Execution</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../worldmodel/state.html"><strong aria-hidden="true">4.1.</strong> The World State</a></li></ol></li><li class="chapter-item expanded "><a href="../test-framework.html"><strong aria-hidden="true">5.</strong> Testing Framework</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tests/coverage.html"><strong aria-hidden="true">5.1.</strong> Test Coverage</a></li></ol></li><li class="chapter-item expanded "><a href="../other_miscellania.html"><strong aria-hidden="true">6.</strong> Miscellenia</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../misc/common.html"><strong aria-hidden="true">6.1.</strong> Module Files</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">Reference</li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Properties</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Actions</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> Activities</div></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Examples</li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../other_miscellania.html">Module Headers and Other Miscellania</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Yaifl Docs</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="worldmodel-and-wmx-type-families"><a class="header" href="#worldmodel-and-wmx-type-families">WorldModel and WMx Type Families</a></h1>
<h2 id="the-problem"><a class="header" href="#the-problem">The problem</a></h2>
<p>One thing that has repeatedly annoyed me when trying to hack around on <code>yaifl</code> is the desire to be as general as possible, but whilst doing my best to avoid writing imperative code but in Haskell. One of these major headscratching problems was how to have something akin to extensible records but in a more Haskell-y way. For instance, take object types. We can provide a standard library of <code>Thing</code>, <code>Room</code>, <code>Door</code>, <code>Person</code>, <code>Vehicle</code>, etc. just fine; but what if we want to have a <code>Gate</code>? In an OO- language this is fine - just inherit from <code>Door</code>. In Haskell we can approximate this in the same way <code>Parsec</code> deals with its error types:</p>
<pre><code class="language-haskell">
data ObjectType a = ThingType Thing | DoorType Door | RoomType Room ... | Other a
</code></pre>
<p>And we are then open (as long as the user supplied <code>a</code> satisfies constraints that we impose, such as <code>Show</code> or <code>Eq</code>) to extensionality but closed at compile time. This has the drawback that if you want this open-closed hierarchy on <em>many</em> types of data, you have a monolithic state that
looks something like <code>MonolithicState a b c d e f g</code>:</p>
<ul>
<li>We want horizontally extendable object types, so we can start with <code>MonolithicWorld objType</code>. All cool.</li>
<li>Now we want directions; whilst the compass points are probably fine for nearly every game, sometimes you might want to have turnwise or widdershins. Now you have <code>MonolithicWorld objType directionType</code>. </li>
<li>What about arbitrary data variables you want to keep track of during the game? Now you've got <code>MonolithicWorld objType directionType variableRecord</code>. </li>
<li>And so on.</li>
</ul>
<p>Chances are that most of those are going to be <code>()</code> - you don't want extra directions, or you don't define a special kind of door - but it's a huge pain to write out multiple times for each function signature.</p>
<p>We could work in an <code>mtl</code>-style way of component instances and typeclasses:</p>
<pre><code class="language-haskell">data MonolithicWorld s = MonolithicWorld
  { ...
  , worldData :: s
  }

data WorldData a b c d e f g = WorldData
  { things :: Store (Object a)
  , directions :: Store (Direction b)
  ...
  -- and so on
  }

class HasThings s a where
  things :: Lens' (MonolithicWorld s) (Store (Object a))

class HasDirections s b where
  directions :: Lens' (MonolithicWorld s) (Store (Direction b))
</code></pre>
<p>But this quickly ran into the same problem; a function that dealt with both <code>Direction</code>s and <code>Object</code>s still needs both <code>a</code> and <code>b</code> to be parametric, and these constraints bubbled up to the top...plus, I'd often get <code>ambiguous type variable a1</code> issues.</p>
<p>What if there was a way to do this with some type-level nonsense?</p>
<h2 id="the-worldmodel-type-families"><a class="header" href="#the-worldmodel-type-families">The WorldModel type families</a></h2>
<p>Behold, a whole bunch of random <code>Type</code>s!</p>
<pre><code class="language-haskell id=world-model">data WorldModel = WorldModel Type Type Type Type
</code></pre>
<p>By using <code>DataKinds</code>, we can promote this to the type level. We can now start making types that look like</p>
<pre><code class="language-haskell">data SomeExtraObjTypes = GateType Gate
type Score = Int
type AWorldModel = 'WorldModel SomeExtraObjTypes () () Score
</code></pre>
<p>which is great; we can parameterise everything by <code>(wm :: WorldModel)</code>, and now we have only one type variable instead of 4 (or more)! But record field accessors don't work at the type-level (F in chat), so we need to write a little boilerplate:</p>
<pre><code class="language-haskell id=world-model-families">type family WMObjSpecifics (wm :: WorldModel) :: Type where
  WMObjSpecifics ('WorldModel objSpec dir o v) = objSpec

type family WMDirections (wm :: WorldModel) :: Type where
  WMDirections ('WorldModel objSpec dir o v) = dir 

type family WMValues (wm :: WorldModel) :: Type where
  WMValues ('WorldModel objSpec dir o v) = o
</code></pre>
<p>How does this work? Without doing a terrible job of massacring an explanation of how type families work, we can view these as very basic dependent types; given some type instantiation of <code>wm :: WorldModel</code>, we have an associated type <code>WMObjSpecifics</code> that is defined by the first member of that type. Now, rather than ever referring to the <code>objSpec</code> we can refer to <code>WMObjSpecifics wm</code>. Everything is unified and there's no unnecessary typeclass baggage, rejoice!</p>
<p>Well, there is one slight issue - this breaks GHC's <code>deriving</code> machinery. Types that contain a <code>WMFoo wm</code> have to instead use quantified instance derivations; for instance we may need to define an <code>Ord</code> instance like</p>
<pre><code class="language-haskell">deriving stock instance (Ord (WMDirections wm), Ord (WMObjSpecifics wm)) =&gt; Ord (FooBar wm)
</code></pre>
<p>which gets minorly annoying. But thanks to <code>ConstraintKinds</code> we can write some tidy helper types.</p>
<pre><code class="language-haskell id=world-model-constraints">type WMConstr (c :: Type -&gt; Constraint) wm = (c (WMObjSpecifics wm), c (WMValues wm), c (WMDirections wm))
type WMShow wm = WMConstr Show wm
type WMRead wm = WMConstr Read wm
type WMOrd wm = WMConstr Ord wm
type WMEq wm = WMConstr Eq wm
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../worldmodel.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../worldmodel/objects.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../worldmodel.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../worldmodel/objects.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
